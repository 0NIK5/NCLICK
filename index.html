<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализатор Эспандера v3 (Band-Pass)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #222; color: #eee; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 10px; }
        
        /* Счетчик */
        .counter-box { font-size: 80px; font-weight: bold; color: #fff; margin: 10px 0; }
        .counter-box.limit { color: #e74c3c; text-shadow: 0 0 20px red; }

        /* Контейнер настроек */
        .panel { background: #333; padding: 15px; border-radius: 10px; width: 95%; max-width: 600px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        canvas { background: #000; border-radius: 4px; width: 100%; height: 150px; border: 1px solid #444; display: block; }

        .info-row { display: flex; justify-content: space-between; font-size: 14px; color: #aaa; margin-bottom: 5px; }
        .peak-hz { color: #00ff00; font-weight: bold; }

        .controls-row { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
        input[type="range"] { flex-grow: 1; margin: 0 10px; cursor: pointer; }
        
        button { padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; color: white; margin-top: 10px;}
        .btn-start { background: #27ae60; width: 100%; }
        .btn-reset { background: #555; }
        
        .status { margin-top: 10px; color: #888; font-size: 12px; }
    </style>
</head>
<body>

    <h2>NCLICK</h2>

    <div class="counter-box" id="counterDisplay">0</div>

    <div class="panel">
        <div class="info-row">
            <span>Басы (Low)</span>
            <span>Спектр звука</span>
            <span>Высокие (High)</span>
        </div>
        <canvas id="spectrumCanvas"></canvas>
        <div class="info-row" style="margin-top: 5px;">
            <span>Пиковая частота (Max Hz): <span class="peak-hz" id="peakHzDisplay">0 Hz</span></span>
        </div>
    </div>

    <div class="panel">
        <h2>Настройка Частотного Диапазона (Band-Pass)</h2>
        
        <div class="info-row" style="color:#2ecc71; margin-top: 10px;">
            <span>**1. НИЖНЯЯ ГРАНИЦА (Low-Cut Filter)**</span>
            <span id="lowcutHzVal">2500 Hz</span>
        </div>
        <div class="controls-row">
            <span>500 Hz</span>
            <input type="range" id="highpassSlider" min="500" max="5000" step="100" value="2500" oninput="updateFilters()">
            <span>5000 Hz</span>
        </div>
        
        <div class="info-row" style="color:#e74c3c; margin-top: 15px;">
            <span>**2. ВЕРХНЯЯ ГРАНИЦА (High-Cut Filter)**</span>
            <span id="highcutHzVal">5000 Hz</span>
        </div>
        <div class="controls-row">
            <span>5000 Hz</span>
            <input type="range" id="lowpassSlider" min="5000" max="20000" step="500" value="5000" oninput="updateFilters()">
            <span>20000 Hz</span>
        </div>
        
        <div class="status" style="margin-top: 10px;">
            Счетчик будет реагировать только на звук **между** этими двумя частотами.
        </div>
    </div>
    
    <div class="panel">
        <h2>Настройка Громкости</h2>
        <div class="info-row">
            <span>3. Порог громкости (Чувствительность)</span>
            <span id="thresholdVal">22</span>
        </div>
        <div class="controls-row">
            <span>0</span>
            <input type="range" id="thresholdSlider" min="0" max="100" value="22">
            <span>100</span>
        </div>
        
        <div style="margin-top: 10px; height: 10px; background: #444; border-radius: 5px; overflow: hidden; position: relative;">
            <div id="currentVolumeBar" style="width: 0%; height: 100%; background: #3498db; transition: width 0.05s;"></div>
            <div id="thresholdMarker" style="position: absolute; left: 22%; top: 0; bottom: 0; width: 2px; background: #e74c3c; z-index: 2;"></div>
        </div>
    </div>

    <div class="panel">
        <label>Цель повторений: <input type="number" id="targetInput" value="20" style="width: 50px; text-align: center; background: #444; color: white; border: none; padding: 5px;"></label>
        <br>
        <button class="btn-start" id="startBtn" onclick="initAudio()">▶ Включить микрофон</button>
        <button class="btn-reset" onclick="resetCounter()" style="width: 100%; margin-top: 5px;">Сброс счетчика</button>
        <div class="status" id="statusText">Ожидание...</div>
    </div>

    <script>
        let audioContext;
        let analyser;
        let microphone;
        let highpassFilter; // Фильтр для нижней границы (Low-Cut)
        let lowpassFilter;  // Фильтр для верхней границы (High-Cut)
        let isListening = false;
        
        let count = 0;
        let lastClapTime = 0;
        const COOLDOWN = 700; 

        // UI Элементы
        const canvas = document.getElementById('spectrumCanvas');
        const ctx = canvas.getContext('2d');
        const peakHzDisplay = document.getElementById('peakHzDisplay');
        const counterDisplay = document.getElementById('counterDisplay');
        const volumeBar = document.getElementById('currentVolumeBar');
        
        const highpassSlider = document.getElementById('highpassSlider');
        const lowpassSlider = document.getElementById('lowpassSlider');
        const lowcutHzVal = document.getElementById('lowcutHzVal');
        const highcutHzVal = document.getElementById('highcutHzVal');

        const thresholdSlider = document.getElementById('thresholdSlider');
        const thresholdMarker = document.getElementById('thresholdMarker');
        const thresholdVal = document.getElementById('thresholdVal');

        const statusText = document.getElementById('statusText');
        const startBtn = document.getElementById('startBtn');
        const targetInput = document.getElementById('targetInput');

        canvas.width = 600;
        canvas.height = 150;

        // --- УПРАВЛЕНИЕ ПОЛЗУНКАМИ ---

        // Обновление ползунка Порога Громкости
        thresholdSlider.oninput = function() {
            thresholdMarker.style.left = this.value + '%';
            thresholdVal.innerText = this.value;
        }

        // Обновление Частотных Фильтров
        function updateFilters() {
            const newHighpassFreq = parseInt(highpassSlider.value);
            const newLowpassFreq = parseInt(lowpassSlider.value);

            lowcutHzVal.innerText = newHighpassFreq + " Hz";
            highcutHzVal.innerText = newLowpassFreq + " Hz";

            // Проверка на корректность диапазона
            if (newHighpassFreq >= newLowpassFreq) {
                // Если нижняя граница выше верхней, мы инвертируем настройки
                lowcutHzVal.style.color = '#e74c3c';
                highcutHzVal.style.color = '#e74c3c';
                statusText.innerText = "ВНИМАНИЕ: Границы фильтра пересекаются!";
            } else {
                lowcutHzVal.style.color = '#2ecc71';
                highcutHzVal.style.color = '#e74c3c';
                if (isListening) statusText.innerText = "Анализ запущен...";
            }


            if (highpassFilter && lowpassFilter) {
                // Меняем частоты среза в реальном времени
                highpassFilter.frequency.setValueAtTime(newHighpassFreq, audioContext.currentTime);
                lowpassFilter.frequency.setValueAtTime(newLowpassFreq, audioContext.currentTime);
            }
        }
        highpassSlider.oninput = updateFilters;
        lowpassSlider.oninput = updateFilters;

        // --- ИНИЦИАЛИЗАЦИЯ АУДИО ---

        async function initAudio() {
            if (isListening) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // 1. Фильтр High-Pass (Low-Cut)
                highpassFilter = audioContext.createBiquadFilter();
                highpassFilter.type = "highpass";
                highpassFilter.frequency.value = parseInt(highpassSlider.value); 
                
                // 2. Фильтр Low-Pass (High-Cut)
                lowpassFilter = audioContext.createBiquadFilter();
                lowpassFilter.type = "lowpass";
                lowpassFilter.frequency.value = parseInt(lowpassSlider.value);
                
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048; 
                
                microphone = audioContext.createMediaStreamSource(stream);
                
                // 3. Сборка Цепочки: Микрофон -> HP-Filter -> LP-Filter -> Анализатор
                microphone.connect(highpassFilter); 
                highpassFilter.connect(lowpassFilter);
                lowpassFilter.connect(analyser); // Анализатор получает только отфильтрованный звук

                isListening = true;
                startBtn.style.display = 'none';
                statusText.innerText = "Анализ запущен...";
                
                draw(); // Запуск цикла отрисовки и детекции
            } catch (err) {
                console.error(err);
                alert("Ошибка микрофона: " + err);
            }
        }

        // --- ЦИКЛ ОТРИСОВКИ И ДЕТЕКЦИИ ---
        function draw() {
            if (!isListening) return;
            requestAnimationFrame(draw);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            // Отрисовка спектра
            ctx.fillStyle = 'rgb(20, 20, 20)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;
            let maxVol = 0;
            let maxIndex = 0;
            let totalVol = 0;

            for(let i = 0; i < bufferLength; i++) {
                barHeight = dataArray[i];
                if (barHeight > maxVol) {
                    maxVol = barHeight;
                    maxIndex = i;
                }
                totalVol += barHeight;

                // Рисуем бары
                ctx.fillStyle = 'rgb(' + (barHeight + 50) + ',150,50)';
                ctx.fillRect(x, canvas.height - barHeight / 2, barWidth, barHeight / 2);

                x += barWidth + 1;
            }

            // Вычисление Пиковой частоты
            const nyquist = audioContext.sampleRate / 2;
            const hzPerBin = nyquist / bufferLength;
            const dominantHz = Math.round(maxIndex * hzPerBin);

            if (maxVol > 30) {
                peakHzDisplay.innerText = dominantHz + " Hz";
            } else {
                peakHzDisplay.innerText = "...";
            }

            // Логика счетчика (основана на средней громкости уже ОТФИЛЬТРОВАННОГО сигнала)
            let averageVol = totalVol / bufferLength;
            let visualVol = averageVol * 3;
            if (visualVol > 100) visualVol = 100;
            
            volumeBar.style.width = visualVol + '%';

            let threshold = parseInt(thresholdSlider.value);
            let now = Date.now();

            if (visualVol > threshold && (now - lastClapTime > COOLDOWN)) {
                triggerCount();
                lastClapTime = now;
            }
        }

        // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---
        function triggerCount() {
            count++;
            counterDisplay.innerText = count;
            
            volumeBar.style.backgroundColor = '#fff';
            setTimeout(() => volumeBar.style.backgroundColor = '#3498db', 100);

            const target = parseInt(targetInput.value);
            if (count >= target) {
                counterDisplay.classList.add('limit');
                statusText.innerText = "ЦЕЛЬ ДОСТИГНУТА! Смени руку.";
                playBeep();            
                resetCounter();
            }
        }

        function resetCounter() {
            count = 0;
            counterDisplay.innerText = "0";
            counterDisplay.classList.remove('limit');
            statusText.innerText = "Счетчик сброшен";
        }

        function playBeep() {
            if (!audioContext) return;
            const osc = audioContext.createOscillator();
            const g = audioContext.createGain();
            osc.connect(g);
            g.connect(audioContext.destination);
            osc.frequency.value = 1500;
            osc.start();
            g.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 2.5);
            osc.stop(audioContext.currentTime + 2.5);
        }
    </script>
</body>
</html>









