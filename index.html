<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—á–µ—Ç—á–∏–∫ –≠—Å–ø–∞–Ω–¥–µ—Ä–∞</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f4f4f9; color: #333; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        h1 { margin-bottom: 10px; }
        
        /* –°—á–µ—Ç—á–∏–∫ */
        .counter-box { font-size: 120px; font-weight: bold; color: #2c3e50; margin: 20px 0; line-height: 1; transition: color 0.2s; }
        .counter-box.limit { color: #e74c3c; } /* –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–∏ */

        /* –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        .controls { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        
        .row { margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
        label { font-weight: 600; }
        input[type="number"] { width: 60px; padding: 5px; font-size: 18px; text-align: center; }

        /* –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–≤—É–∫–∞ */
        .visualizer-container {
            width: 100%; height: 40px; background: #ddd; border-radius: 20px; position: relative; overflow: hidden; margin-top: 10px;
        }
        /* –°–∏–Ω—è—è –ø–æ–ª–æ—Å–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ */
        #volume-bar {
            height: 100%; width: 0%; background: #3498db; transition: width 0.05s ease-out;
        }
        /* –ö—Ä–∞—Å–Ω–∞—è –ª–∏–Ω–∏—è –ø–æ—Ä–æ–≥–∞ */
        #threshold-line {
            position: absolute; top: 0; bottom: 0; width: 4px; background: #e74c3c; left: 50%; z-index: 10; cursor: col-resize;
        }
        
        input[type="range"] { width: 100%; cursor: pointer; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { padding: 15px 30px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; color: white; margin: 5px; transition: 0.2s; }
        .btn-start { background: #27ae60; }
        .btn-start:hover { background: #219150; }
        .btn-reset { background: #95a5a6; }
        .btn-reset:hover { background: #7f8c8d; }

        .status { font-size: 14px; color: #777; margin-top: 10px; min-height: 20px;}
    </style>
</head>
<body>

    <h1>–°—á–µ—Ç—á–∏–∫ –≠—Å–ø–∞–Ω–¥–µ—Ä–∞</h1>

    <div class="counter-box" id="counterDisplay">0</div>

    <div class="controls">
        <div class="row">
            <label>–¶–µ–ª—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π:</label>
            <input type="number" id="targetInput" value="20">
        </div>

        <hr>

        <div class="row" style="display:block; text-align:left;">
            <label>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ü–æ—Ä–æ–≥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è):</label>
            <input type="range" id="thresholdSlider" min="0" max="100" value="30">
        </div>
        
        <div class="visualizer-container">
            <div id="volume-bar"></div>
            <div id="threshold-line" style="left: 30%;"></div>
        </div>
        <div style="font-size: 12px; color: #888; margin-top: 5px;">
            –°–∏–Ω—è—è –ø–æ–ª–æ—Å–∫–∞ –¥–æ–ª–∂–Ω–∞ –ø—Ä—ã–≥–∞—Ç—å –ó–ê –∫—Ä–∞—Å–Ω—É—é –ª–∏–Ω–∏—é —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —â–µ–ª—á–∫–µ.
        </div>

        <hr>

        <button class="btn btn-start" id="startBtn" onclick="initAudio()">üé§ –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
        <button class="btn btn-reset" onclick="resetCounter()">–°–±—Ä–æ—Å (0)</button>
        
        <div class="status" id="statusText">–ù–∞–∂–º–∏ "–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω" –¥–ª—è –Ω–∞—á–∞–ª–∞</div>
    </div>

    <script>
        let audioContext;
        let analyser;
        let microphone;
        let isListening = false;
        let count = 0;
        let lastClapTime = 0;
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        const COOLDOWN = 500; // –ü–∞—É–∑–∞ –≤ –º—Å –ø–æ—Å–ª–µ —â–µ–ª—á–∫–∞ (—á—Ç–æ–±—ã –Ω–µ —Å—á–∏—Ç–∞–ª–æ –¥–≤–æ–π–Ω–æ–π —É–¥–∞—Ä)
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã UI
        const counterDisplay = document.getElementById('counterDisplay');
        const volumeBar = document.getElementById('volume-bar');
        const thresholdLine = document.getElementById('threshold-line');
        const thresholdSlider = document.getElementById('thresholdSlider');
        const statusText = document.getElementById('statusText');
        const startBtn = document.getElementById('startBtn');
        const targetInput = document.getElementById('targetInput');

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è –∫—Ä–∞—Å–Ω–æ–π –ª–∏–Ω–∏–∏ –ø—Ä–∏ —Å–¥–≤–∏–≥–µ –ø–æ–ª–∑—É–Ω–∫–∞
        thresholdSlider.oninput = function() {
            thresholdLine.style.left = this.value + '%';
        }

        async function initAudio() {
            if (isListening) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // –°–æ–∑–¥–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –≤—ã—Å–æ–∫–∏—Ö —á–∞—Å—Ç–æ—Ç (High-pass filter)
                // –û–Ω —É–±–∏—Ä–∞–µ—Ç –≥—É–ª –∏ –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–∑–∫–∏–µ "—Ü—ã–∫–∞—é—â–∏–µ" –∑–≤—É–∫–∏
                const filter = audioContext.createBiquadFilter();
                filter.type = "highpass";
                filter.frequency.value = 1000; // –û—Ç—Ä–µ–∑–∞–µ–º –≤—Å—ë, —á—Ç–æ –Ω–∏–∂–µ 1000 –ì—Ü

                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512; // –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

                // –¶–µ–ø–æ—á–∫–∞: –ú–∏–∫—Ä–æ—Ñ–æ–Ω -> –§–∏–ª—å—Ç—Ä -> –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä
                microphone.connect(filter);
                filter.connect(analyser);

                isListening = true;
                startBtn.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                statusText.innerText = "–°–ª—É—à–∞—é... –°–æ–∂–º–∏ —ç—Å–ø–∞–Ω–¥–µ—Ä!";
                
                detectSound();

            } catch (err) {
                statusText.innerText = "–û—à–∏–±–∫–∞: –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω.";
                console.error(err);
            }
        }

        function detectSound() {
            if (!isListening) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω—é—é –≥—Ä–æ–º–∫–æ—Å—Ç—å –≤—ã—Å–æ–∫–∏—Ö —á–∞—Å—Ç–æ—Ç
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            let average = sum / dataArray.length;
            
            // –£—Å–∏–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ (—É–º–Ω–æ–∂–∞–µ–º –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç)
            let visualValue = average * 3; 
            if (visualValue > 100) visualValue = 100;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏–Ω—é—é –ø–æ–ª–æ—Å–∫—É
            volumeBar.style.width = visualValue + '%';

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É–¥–∞—Ä
            let threshold = thresholdSlider.value;
            let now = Date.now();

            // –ï–°–õ–ò –≥—Ä–æ–º–∫–æ—Å—Ç—å –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞ –ò –ø—Ä–æ—à–ª–æ –≤—Ä–µ–º—è –∑–∞–¥–µ—Ä–∂–∫–∏ (COOLDOWN)
            if (visualValue > threshold && (now - lastClapTime > COOLDOWN)) {
                
                count++;
                updateCounterUI();
                lastClapTime = now;
                
                // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç "–≤—Å–ø—ã—à–∫–∏" –Ω–∞ –ø–æ–ª–æ—Å–∫–µ
                volumeBar.style.backgroundColor = '#2ecc71';
                setTimeout(() => volumeBar.style.backgroundColor = '#3498db', 100);
            }

            requestAnimationFrame(detectSound);
        }

        function updateCounterUI() {
            counterDisplay.innerText = count;
            const target = parseInt(targetInput.value);

            if (count >= target) {
                counterDisplay.classList.add('limit');
                statusText.innerText = "–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞! –°–º–µ–Ω–∏ —Ä—É–∫—É.";
                playBeep(); // –ó–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª
            } else {
                counterDisplay.classList.remove('limit');
                statusText.innerText = "–°–ª—É—à–∞—é...";
            }
        }

        function resetCounter() {
            count = 0;
            counterDisplay.classList.remove('limit');
            updateCounterUI();
            statusText.innerText = isListening ? "–°–ª—É—à–∞—é..." : "–°—á–µ—Ç—á–∏–∫ —Å–±—Ä–æ—à–µ–Ω";
        }

        // –°–∏–Ω—Ç–µ–∑ –∑–≤—É–∫–∞ "–ë–∏–ø" –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö —Ñ–∞–π–ª–æ–≤
        function playBeep() {
            if (!audioContext) return;
            const osc = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            osc.connect(gainNode);
            gainNode.connect(audioContext.destination);

            osc.type = 'sine';
            osc.frequency.value = 880; // –ù–æ—Ç–∞ –õ—è (–≤—ã—Å–æ–∫–∏–π –ø–∏—Å–∫)
            
            osc.start();
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5);
            osc.stop(audioContext.currentTime + 0.5);
        }
    </script>
</body>

</html>
