<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≠—Å–ø–∞–Ω–¥–µ—Ä–∞ v3 (Band-Pass)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #222; color: #eee; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 10px; }
        
        /* –°—á–µ—Ç—á–∏–∫ */
        .counter-box { font-size: 80px; font-weight: bold; color: #fff; margin: 10px 0; }
        .counter-box.limit { color: #e74c3c; text-shadow: 0 0 20px red; }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        .panel { background: #333; padding: 15px; border-radius: 10px; width: 95%; max-width: 600px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        canvas { background: #000; border-radius: 4px; width: 100%; height: 150px; border: 1px solid #444; display: block; }

        .info-row { display: flex; justify-content: space-between; font-size: 14px; color: #aaa; margin-bottom: 5px; }
        .peak-hz { color: #00ff00; font-weight: bold; }

        .controls-row { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
        input[type="range"] { flex-grow: 1; margin: 0 10px; cursor: pointer; }
        
        button { padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; color: white; margin-top: 10px;}
        .btn-start { background: #27ae60; width: 100%; }
        .btn-reset { background: #555; }
        
        .status { margin-top: 10px; color: #888; font-size: 12px; }
    </style>
</head>
<body>

    <h1>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≠—Å–ø–∞–Ω–¥–µ—Ä–∞ üî¨</h1>

    <div class="counter-box" id="counterDisplay">0</div>

    <div class="panel">
        <div class="info-row">
            <span>–ë–∞—Å—ã (Low)</span>
            <span>–°–ø–µ–∫—Ç—Ä –∑–≤—É–∫–∞</span>
            <span>–í—ã—Å–æ–∫–∏–µ (High)</span>
        </div>
        <canvas id="spectrumCanvas"></canvas>
        <div class="info-row" style="margin-top: 5px;">
            <span>–ü–∏–∫–æ–≤–∞—è —á–∞—Å—Ç–æ—Ç–∞ (Max Hz): <span class="peak-hz" id="peakHzDisplay">0 Hz</span></span>
        </div>
    </div>

    <div class="panel">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ß–∞—Å—Ç–æ—Ç–Ω–æ–≥–æ –î–∏–∞–ø–∞–∑–æ–Ω–∞ (Band-Pass)</h2>
        
        <div class="info-row" style="color:#2ecc71; margin-top: 10px;">
            <span>**1. –ù–ò–ñ–ù–Ø–Ø –ì–†–ê–ù–ò–¶–ê (Low-Cut Filter)**</span>
            <span id="lowcutHzVal">1500 Hz</span>
        </div>
        <div class="controls-row">
            <span>500 Hz</span>
            <input type="range" id="highpassSlider" min="500" max="5000" step="100" value="1500" oninput="updateFilters()">
            <span>5000 Hz</span>
        </div>
        
        <div class="info-row" style="color:#e74c3c; margin-top: 15px;">
            <span>**2. –í–ï–†–•–ù–Ø–Ø –ì–†–ê–ù–ò–¶–ê (High-Cut Filter)**</span>
            <span id="highcutHzVal">15000 Hz</span>
        </div>
        <div class="controls-row">
            <span>5000 Hz</span>
            <input type="range" id="lowpassSlider" min="5000" max="20000" step="500" value="15000" oninput="updateFilters()">
            <span>20000 Hz</span>
        </div>
        
        <div class="status" style="margin-top: 10px;">
            –°—á–µ—Ç—á–∏–∫ –±—É–¥–µ—Ç —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ –∑–≤—É–∫ **–º–µ–∂–¥—É** —ç—Ç–∏–º–∏ –¥–≤—É–º—è —á–∞—Å—Ç–æ—Ç–∞–º–∏.
        </div>
    </div>
    
    <div class="panel">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ì—Ä–æ–º–∫–æ—Å—Ç–∏</h2>
        <div class="info-row">
            <span>3. –ü–æ—Ä–æ–≥ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ (–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)</span>
            <span id="thresholdVal">30</span>
        </div>
        <div class="controls-row">
            <span>0</span>
            <input type="range" id="thresholdSlider" min="0" max="100" value="30">
            <span>100</span>
        </div>
        
        <div style="margin-top: 10px; height: 10px; background: #444; border-radius: 5px; overflow: hidden; position: relative;">
            <div id="currentVolumeBar" style="width: 0%; height: 100%; background: #3498db; transition: width 0.05s;"></div>
            <div id="thresholdMarker" style="position: absolute; left: 30%; top: 0; bottom: 0; width: 2px; background: #e74c3c; z-index: 2;"></div>
        </div>
    </div>

    <div class="panel">
        <label>–¶–µ–ª—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π: <input type="number" id="targetInput" value="20" style="width: 50px; text-align: center; background: #444; color: white; border: none; padding: 5px;"></label>
        <br>
        <button class="btn-start" id="startBtn" onclick="initAudio()">‚ñ∂ –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
        <button class="btn-reset" onclick="resetCounter()" style="width: 100%; margin-top: 5px;">–°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞</button>
        <div class="status" id="statusText">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>

    <script>
        let audioContext;
        let analyser;
        let microphone;
        let highpassFilter; // –§–∏–ª—å—Ç—Ä –¥–ª—è –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã (Low-Cut)
        let lowpassFilter;  // –§–∏–ª—å—Ç—Ä –¥–ª—è –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã (High-Cut)
        let isListening = false;
        
        let count = 0;
        let lastClapTime = 0;
        const COOLDOWN = 300; 

        // UI –≠–ª–µ–º–µ–Ω—Ç—ã
        const canvas = document.getElementById('spectrumCanvas');
        const ctx = canvas.getContext('2d');
        const peakHzDisplay = document.getElementById('peakHzDisplay');
        const counterDisplay = document.getElementById('counterDisplay');
        const volumeBar = document.getElementById('currentVolumeBar');
        
        const highpassSlider = document.getElementById('highpassSlider');
        const lowpassSlider = document.getElementById('lowpassSlider');
        const lowcutHzVal = document.getElementById('lowcutHzVal');
        const highcutHzVal = document.getElementById('highcutHzVal');

        const thresholdSlider = document.getElementById('thresholdSlider');
        const thresholdMarker = document.getElementById('thresholdMarker');
        const thresholdVal = document.getElementById('thresholdVal');

        const statusText = document.getElementById('statusText');
        const startBtn = document.getElementById('startBtn');
        const targetInput = document.getElementById('targetInput');

        canvas.width = 600;
        canvas.height = 150;

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–ó–£–ù–ö–ê–ú–ò ---

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∑—É–Ω–∫–∞ –ü–æ—Ä–æ–≥–∞ –ì—Ä–æ–º–∫–æ—Å—Ç–∏
        thresholdSlider.oninput = function() {
            thresholdMarker.style.left = this.value + '%';
            thresholdVal.innerText = this.value;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ß–∞—Å—Ç–æ—Ç–Ω—ã—Ö –§–∏–ª—å—Ç—Ä–æ–≤
        function updateFilters() {
            const newHighpassFreq = parseInt(highpassSlider.value);
            const newLowpassFreq = parseInt(lowpassSlider.value);

            lowcutHzVal.innerText = newHighpassFreq + " Hz";
            highcutHzVal.innerText = newLowpassFreq + " Hz";

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω–∞
            if (newHighpassFreq >= newLowpassFreq) {
                // –ï—Å–ª–∏ –Ω–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –≤—ã—à–µ –≤–µ—Ä—Ö–Ω–µ–π, –º—ã –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                lowcutHzVal.style.color = '#e74c3c';
                highcutHzVal.style.color = '#e74c3c';
                statusText.innerText = "–í–ù–ò–ú–ê–ù–ò–ï: –ì—Ä–∞–Ω–∏—Ü—ã —Ñ–∏–ª—å—Ç—Ä–∞ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è!";
            } else {
                lowcutHzVal.style.color = '#2ecc71';
                highcutHzVal.style.color = '#e74c3c';
                if (isListening) statusText.innerText = "–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω...";
            }


            if (highpassFilter && lowpassFilter) {
                // –ú–µ–Ω—è–µ–º —á–∞—Å—Ç–æ—Ç—ã —Å—Ä–µ–∑–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                highpassFilter.frequency.setValueAtTime(newHighpassFreq, audioContext.currentTime);
                lowpassFilter.frequency.setValueAtTime(newLowpassFreq, audioContext.currentTime);
            }
        }
        highpassSlider.oninput = updateFilters;
        lowpassSlider.oninput = updateFilters;

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ê–£–î–ò–û ---

        async function initAudio() {
            if (isListening) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // 1. –§–∏–ª—å—Ç—Ä High-Pass (Low-Cut)
                highpassFilter = audioContext.createBiquadFilter();
                highpassFilter.type = "highpass";
                highpassFilter.frequency.value = parseInt(highpassSlider.value); 
                
                // 2. –§–∏–ª—å—Ç—Ä Low-Pass (High-Cut)
                lowpassFilter = audioContext.createBiquadFilter();
                lowpassFilter.type = "lowpass";
                lowpassFilter.frequency.value = parseInt(lowpassSlider.value);
                
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048; 
                
                microphone = audioContext.createMediaStreamSource(stream);
                
                // 3. –°–±–æ—Ä–∫–∞ –¶–µ–ø–æ—á–∫–∏: –ú–∏–∫—Ä–æ—Ñ–æ–Ω -> HP-Filter -> LP-Filter -> –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä
                microphone.connect(highpassFilter); 
                highpassFilter.connect(lowpassFilter);
                lowpassFilter.connect(analyser); // –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–≤—É–∫

                isListening = true;
                startBtn.style.display = 'none';
                statusText.innerText = "–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω...";
                
                draw(); // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∏ –¥–µ—Ç–µ–∫—Ü–∏–∏
            } catch (err) {
                console.error(err);
                alert("–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: " + err);
            }
        }

        // --- –¶–ò–ö–õ –û–¢–†–ò–°–û–í–ö–ò –ò –î–ï–¢–ï–ö–¶–ò–ò ---
        function draw() {
            if (!isListening) return;
            requestAnimationFrame(draw);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–µ–∫—Ç—Ä–∞
            ctx.fillStyle = 'rgb(20, 20, 20)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;
            let maxVol = 0;
            let maxIndex = 0;
            let totalVol = 0;

            for(let i = 0; i < bufferLength; i++) {
                barHeight = dataArray[i];
                if (barHeight > maxVol) {
                    maxVol = barHeight;
                    maxIndex = i;
                }
                totalVol += barHeight;

                // –†–∏—Å—É–µ–º –±–∞—Ä—ã
                ctx.fillStyle = 'rgb(' + (barHeight + 50) + ',150,50)';
                ctx.fillRect(x, canvas.height - barHeight / 2, barWidth, barHeight / 2);

                x += barWidth + 1;
            }

            // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ü–∏–∫–æ–≤–æ–π —á–∞—Å—Ç–æ—Ç—ã
            const nyquist = audioContext.sampleRate / 2;
            const hzPerBin = nyquist / bufferLength;
            const dominantHz = Math.round(maxIndex * hzPerBin);

            if (maxVol > 30) {
                peakHzDisplay.innerText = dominantHz + " Hz";
            } else {
                peakHzDisplay.innerText = "...";
            }

            // –õ–æ–≥–∏–∫–∞ —Å—á–µ—Ç—á–∏–∫–∞ (–æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ —Å—Ä–µ–¥–Ω–µ–π –≥—Ä–æ–º–∫–æ—Å—Ç–∏ —É–∂–µ –û–¢–§–ò–õ–¨–¢–†–û–í–ê–ù–ù–û–ì–û —Å–∏–≥–Ω–∞–ª–∞)
            let averageVol = totalVol / bufferLength;
            let visualVol = averageVol * 3;
            if (visualVol > 100) visualVol = 100;
            
            volumeBar.style.width = visualVol + '%';

            let threshold = parseInt(thresholdSlider.value);
            let now = Date.now();

            if (visualVol > threshold && (now - lastClapTime > COOLDOWN)) {
                triggerCount();
                lastClapTime = now;
            }
        }

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function triggerCount() {
            count++;
            counterDisplay.innerText = count;
            
            volumeBar.style.backgroundColor = '#fff';
            setTimeout(() => volumeBar.style.backgroundColor = '#3498db', 100);

            const target = parseInt(targetInput.value);
            if (count >= target) {
                counterDisplay.classList.add('limit');
                statusText.innerText = "–¶–ï–õ–¨ –î–û–°–¢–ò–ì–ù–£–¢–ê! –°–º–µ–Ω–∏ —Ä—É–∫—É.";
                playBeep();
            }
        }

        function resetCounter() {
            count = 0;
            counterDisplay.innerText = "0";
            counterDisplay.classList.remove('limit');
            statusText.innerText = "–°—á–µ—Ç—á–∏–∫ —Å–±—Ä–æ—à–µ–Ω";
        }

        function playBeep() {
            if (!audioContext) return;
            const osc = audioContext.createOscillator();
            const g = audioContext.createGain();
            osc.connect(g);
            g.connect(audioContext.destination);
            osc.frequency.value = 800;
            osc.start();
            g.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5);
            osc.stop(audioContext.currentTime + 0.5);
        }
    </script>
</body>
</html>
