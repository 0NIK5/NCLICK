<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализатор Эспандера v3 (Band-Pass)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #222; color: #eee; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 5px; }
        
        /* Счетчик */
        .counter-box { font-size: 24px; font-weight: bold; color: #fff; margin: 2px 0; }
        .counter-box.limit { color: #e74c3c; text-shadow: 0 0 20px red; }

        /* Контейнер настроек */
        .panel { background: #333; padding: 8px; border-radius: 8px; width: 95%; max-width: 600px; margin-bottom: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        canvas { background: #000; border-radius: 4px; width: 100%; height: 90px; border: 1px solid #444; display: block; }

        .info-row { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-bottom: 3px; }
        .peak-hz { color: #00ff00; font-weight: bold; }

        .controls-row { display: flex; align-items: center; justify-content: space-between; margin-top: 5px; }
        input[type="range"] { flex-grow: 1; margin: 0 8px; cursor: pointer; }
        
        button { padding: 6px 12px; font-size: 13px; border: none; border-radius: 5px; cursor: pointer; color: white; margin-top: 5px;}
        .btn-start { background: #27ae60; width: 100%; }
        .btn-reset { background: #555;  }
        
        .status { margin-top: 5px; color: #888; font-size: 11px; }
        
        h2 { margin: 1px 0; }
        h3 { margin: 1px 0; }
    </style>
</head>
<body>

    <h2>NCLICK</h2>

    <div class="counter-box" id="counterDisplay">0</div>

    <div class="panel">
        <div class="info-row">
            <span>Басы (Low)</span>
            <span>Спектр звука</span>
            <span>Высокие (High)</span>
        </div>
        <canvas id="spectrumCanvas"></canvas>
        <div class="info-row" style="margin-top: 5px;">
            <span>Пиковая частота (Max Hz): <span class="peak-hz" id="peakHzDisplay">0 Hz</span></span>
        </div>
    </div>

    <div class="panel">
        <h3>Настройка Частотного Диапазона (Band-Pass)</h3>
        
        <div class="info-row" style="color:#2ecc71; margin-top: 10px;">
            <span>**1. НИЖНЯЯ ГРАНИЦА (Low-Cut Filter)**</span>
            <span id="lowcutHzVal">2100 Hz</span>
        </div>
        <div class="controls-row">
            <span>100 Hz</span>
            <input type="range" id="highpassSlider" min="100" max="15000" step="100" value="2100" oninput="updateFilters()">
            <span>15000 Hz</span>
        </div>
        
        <div class="info-row" style="color:#e74c3c; margin-top: 15px;">
            <span>**2. ВЕРХНЯЯ ГРАНИЦА (High-Cut Filter)**</span>
            <span id="highcutHzVal">5000 Hz</span>
        </div>
        <div class="controls-row">
            <span>2000 Hz</span>
            <input type="range" id="lowpassSlider" min="2000" max="20000" step="100" value="5000" oninput="updateFilters()">
            <span>20000 Hz</span>
        </div>
        
        <div class="status" style="margin-top: 10px;">
            Счетчик будет реагировать только на звук **между** этими двумя частотами.
        </div>
    </div>
    
    <div class="panel">
        <h3>Настройка Громкости</h3>
        <div class="info-row">
            <span>3. Порог громкости (Чувствительность)</span>
            <span id="thresholdVal">22</span>
        </div>
        <div class="controls-row">
            <span>0</span>
            <input type="range" id="thresholdSlider" min="0" max="100" value="22">
            <span>100</span>
        </div>
        
        <div style="margin-top: 10px; height: 10px; background: #444; border-radius: 5px; overflow: hidden; position: relative;">
            <div id="currentVolumeBar" style="width: 0%; height: 100%; background: #3498db; transition: width 0.05s;"></div>
            <div id="thresholdMarker" style="position: absolute; left: 22%; top: 0; bottom: 0; width: 2px; background: #e74c3c; z-index: 2;"></div>
        </div>
    </div>

    <div class="panel">
        <label>Цель повторений: <input type="number" id="targetInput" value="20" style="width: 50px; text-align: center; background: #444; color: white; border: none; padding: 5px;"></label>
        <br>
        <button class="btn-start" id="startBtn" onclick="initAudio()">▶ Включить микрофон</button>
        <button class="btn-reset" onclick="resetCounter()" style="width: 100%; margin-top: 5px;">Сброс счетчика</button>
        <button class="btn-reset" onclick="isListening = false; startBtn.style.display = 'block';" style="width: 100%; margin-top: 5px;">Stop</button>
        
        <div class="status" id="statusText">Ожидание...</div>
    </div>

    <script>
        let audioContext;
        let analyser;
        let microphone;
        let scriptProcessor;
        let isListening = false;
        
        let count = 0;
        let lastClapTime = 0;
        const COOLDOWN = 600;
        
        // Для анализа во временной области
        let audioBuffer = [];
        let detectedFrequency = 0;

        // UI Элементы
        const canvas = document.getElementById('spectrumCanvas');
        const ctx = canvas.getContext('2d');
        const peakHzDisplay = document.getElementById('peakHzDisplay');
        const counterDisplay = document.getElementById('counterDisplay');
        const volumeBar = document.getElementById('currentVolumeBar');
        
        const highpassSlider = document.getElementById('highpassSlider');
        const lowpassSlider = document.getElementById('lowpassSlider');
        const lowcutHzVal = document.getElementById('lowcutHzVal');
        const highcutHzVal = document.getElementById('highcutHzVal');

        const thresholdSlider = document.getElementById('thresholdSlider');
        const thresholdMarker = document.getElementById('thresholdMarker');
        const thresholdVal = document.getElementById('thresholdVal');

        const statusText = document.getElementById('statusText');
        const startBtn = document.getElementById('startBtn');
        const targetInput = document.getElementById('targetInput');

        canvas.width = 600;
        canvas.height = 90;

        // --- УПРАВЛЕНИЕ ПОЛЗУНКАМИ ---

        // Обновление ползунка Порога Громкости
        thresholdSlider.oninput = function() {
            thresholdMarker.style.left = this.value + '%';
            thresholdVal.innerText = this.value;
        }

        // Обновление Частотных Фильтров
        function updateFilters() {
            let newHighpassFreq = parseInt(highpassSlider.value);
            let newLowpassFreq = parseInt(lowpassSlider.value);

            // Проверка на корректность диапазона
            if (newHighpassFreq >= newLowpassFreq) {
                // Если нижняя граница >= верхней, скорректировать нижнюю
                newHighpassFreq = newLowpassFreq - 1000;
                if (newHighpassFreq < 100) newHighpassFreq = 100;
                highpassSlider.value = newHighpassFreq;
                
                lowcutHzVal.style.color = '#e74c3c';
                highcutHzVal.style.color = '#e74c3c';
                statusText.innerText = "⚠️ Границы пересекаются! Автокоррекция...";
            } else {
                lowcutHzVal.style.color = '#2ecc71';
                highcutHzVal.style.color = '#e74c3c';
                if (isListening) statusText.innerText = "✓ Анализ запущен...";
            }

            lowcutHzVal.innerText = newHighpassFreq + " Hz";
            highcutHzVal.innerText = newLowpassFreq + " Hz";
        }
        highpassSlider.oninput = updateFilters;
        lowpassSlider.oninput = updateFilters;

        // --- ИНИЦИАЛИЗАЦИЯ АУДИО ---

        async function initAudio() {
            if (isListening) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 4096;
                analyser.smoothingTimeConstant = 0.3;
                
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                // Создаём процессор для анализа сырых данных (с проверкой поддержки)
                try {
                    const bufferSize = 4096;
                    scriptProcessor = audioContext.createScriptProcessor(bufferSize, 1, 1);
                    
                    // Подключаем микрофон к процессору
                    microphone.connect(scriptProcessor);
                    scriptProcessor.connect(audioContext.destination);
                    
                    // Обработка сырых audio данных
                    scriptProcessor.onaudioprocess = function(event) {
                        try {
                            const inputData = event.inputBuffer.getChannelData(0);
                            if (inputData && inputData.length > 0) {
                                audioBuffer = Array.from(inputData);
                            }
                        } catch(e) {
                            console.log("Ошибка при обработке audio: ", e);
                        }
                    };
                } catch(e) {
                    console.warn("ScriptProcessor не поддерживается: ", e);
                }

                isListening = true;
                startBtn.style.display = 'none';
                statusText.innerText = "✓ Анализ запущен...";
                
                draw();
            } catch (err) {
                console.error(err);
                alert("Ошибка микрофона: " + err);
            }
        }        // Функция для детекции частоты методом подсчёта нулевых переходов
        function detectFrequency(buffer) {
            if (!buffer || buffer.length < 100) return 0;
            
            try {
                // Ищем частоту методом подсчёта нулевых переходов (ZCR)
                let zeroCount = 0;
                for (let i = 1; i < buffer.length; i++) {
                    if ((buffer[i] >= 0 && buffer[i-1] < 0) || (buffer[i] < 0 && buffer[i-1] >= 0)) {
                        zeroCount++;
                    }
                }
                
                // Частота примерно = количество переходов * sampleRate / 2 / длину буфера
                if (audioContext && audioContext.sampleRate && buffer.length > 0) {
                    const frequency = (zeroCount * audioContext.sampleRate) / (2 * buffer.length);
                    return Math.max(0, frequency);
                }
            } catch(e) {
                console.log("Ошибка в detectFrequency: ", e);
            }
            return 0;
        }
        
        // Функция для подсчёта RMS (энергии сигнала)
        function calculateRMS(buffer) {
            if (!buffer || buffer.length === 0) return 0;
            
            try {
                let sum = 0;
                for (let i = 0; i < buffer.length; i++) {
                    sum += buffer[i] * buffer[i];
                }
                return Math.sqrt(sum / buffer.length);
            } catch(e) {
                console.log("Ошибка в calculateRMS: ", e);
            }
            return 0;
        }
        
        // --- ЦИКЛ ОТРИСОВКИ И ДЕТЕКЦИИ ---
        function draw() {
            if (!isListening) return;
            requestAnimationFrame(draw);

            try {
                // Получаем спектр для визуализации
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);

                // Отрисовка спектра
                ctx.fillStyle = 'rgb(20, 20, 20)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const barWidth = (canvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;
                let maxVol = 0;
                let maxIndex = 0;

                // Получаем диапазон частот
                const nyquist = audioContext.sampleRate / 2;
                const hzPerBin = nyquist / bufferLength;
                const highpassFreq = parseInt(highpassSlider.value);
                const lowpassFreq = parseInt(lowpassSlider.value);
                const startBin = Math.max(0, Math.round(highpassFreq / hzPerBin));
                const endBin = Math.min(bufferLength - 1, Math.round(lowpassFreq / hzPerBin));

                let filteredMaxVol = 0;
                let filteredTotalVol = 0;
                let filteredBinCount = 0;

                for(let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i];
                    
                    if (barHeight > maxVol) {
                        maxVol = barHeight;
                        maxIndex = i;
                    }

                    if (i >= startBin && i <= endBin) {
                        if (barHeight > filteredMaxVol) {
                            filteredMaxVol = barHeight;
                        }
                        filteredTotalVol += barHeight;
                        filteredBinCount++;
                        ctx.fillStyle = 'rgb(' + Math.min(barHeight + 100, 255) + ',220,80)';
                    } else {
                        ctx.fillStyle = 'rgb(' + Math.min(barHeight + 30, 200) + ',100,30)';
                    }
                    
                    ctx.fillRect(x, canvas.height - barHeight / 2, barWidth, barHeight / 2);
                    x += barWidth + 1;
                }

                const dominantHz = Math.round(maxIndex * hzPerBin);

                if (maxVol > 30) {
                    peakHzDisplay.innerText = dominantHz + " Hz";
                } else {
                    peakHzDisplay.innerText = "...";
                }

                // Анализ во временной области
                const currentFrequency = detectFrequency(audioBuffer);
                const rmsEnergy = calculateRMS(audioBuffer);
                
                // Визуализация на основе спектра в отфильтрованной полосе
                let visualVol = (filteredMaxVol / 255) * 100;
                if (visualVol > 100) visualVol = 100;
                
                volumeBar.style.width = visualVol + '%';

                let threshold = parseInt(thresholdSlider.value);
                let now = Date.now();

                // ДЕТЕКЦИЯ: Проверяем ОБОИХ условия:
                // 1. Детектированная частота в установленном диапазоне
                // 2. Энергия выше порога
                
                const thresholdValue = threshold * 2.55;
                const isFrequencyInRange = currentFrequency >= highpassFreq && currentFrequency <= lowpassFreq;
                const isEnergyHigh = rmsEnergy > (threshold / 100) * 0.05;
                
                if (isFrequencyInRange && isEnergyHigh && (now - lastClapTime > COOLDOWN)) {
                    triggerCount();
                    lastClapTime = now;
                }
            } catch(e) {
                console.error("Ошибка в draw: ", e);
            }
        }

        // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---
        function triggerCount() {
            count++;
            counterDisplay.innerText = count;
            
            volumeBar.style.backgroundColor = '#fff';
            setTimeout(() => volumeBar.style.backgroundColor = '#3498db', 100);

            const target = parseInt(targetInput.value);
            if (count >= target) {
                counterDisplay.classList.add('limit');
                statusText.innerText = "ЦЕЛЬ ДОСТИГНУТА! Смени руку.";
                playBeep();            
                resetCounter();
            }
        }

        function resetCounter() {
            count = 0;
            counterDisplay.innerText = "0";
            counterDisplay.classList.remove('limit');
            statusText.innerText = "Счетчик сброшен";
        }

        function playBeep() {
            if (!audioContext) return;
            const osc = audioContext.createOscillator();
            const g = audioContext.createGain();
            osc.connect(g);
            g.connect(audioContext.destination);
            osc.frequency.value = 1500;
            osc.start();
            g.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 2.5);
            osc.stop(audioContext.currentTime + 2.5);
        }
    </script>
</body>
</html>









